<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">


<meta name="wpd_version" content="0.2">
<meta name="wpd_baseurl" content="http://www.sciencedirect.com/science/article/pii/S0042682285710161">
<meta name="wpd_url" content="http://sciverse-shindig.elsevier.com/gadgets/ifr?container=default&amp;mid=3&amp;nocache=1&amp;country=ALL&amp;lang=ALL&amp;view=profile&amp;parent=http%3A%2F%2Fwww.sciencedirect.com%2Fscience%2Farticle%2Fpii%2FS0042682285710161%3A%2F%2Fwww.sciencedirect.com&amp;st=john.doe:john.doe:appid:cont:url:0:default&amp;url=http%3A%2F%2Fae-content.elsevier.com%2Fsvapp%2F293793%2Fprod%2Fprivate%2Fspec.xml#rpctoken=1307440515">
<meta name="wpd_date" content="2013-04-10T23:46Z">
<script src="ga.js" async="" type="text/javascript"></script><script src="ga.js" async="" type="text/javascript"></script><script>window['__isgadget']=true;</script><script src="corerpc.js"></script><script>gadgets.sciverse={};
(function(){gadgets.sciverse.getAllResults=function(A){gadgets.rpc.call(null,"getAllResults",A,null)
};
gadgets.sciverse.getArticleContent=function(A){if(typeof (A)=="undefined"||A==null){return 
}var B="gac";
gadgets.rpc.call(null,"getArticleContent",null,false,B);
gadgets.rpc.register(B,A)
};
gadgets.sciverse.getCurrentArticleContent=function(A){if(typeof (A)=="undefined"||A==null){return 
}var B="gcac";
gadgets.rpc.call(null,"getArticleContent",null,true,B);
gadgets.rpc.register(B,A)
};
gadgets.sciverse.getContent=function(B,A){if(typeof (A)=="undefined"||A==null){return 
}gadgets.rpc.call(null,"getContent",null,B);
gadgets.rpc.register(B,A)
};
gadgets.sciverse.getContextInfo=function(A){gadgets.rpc.call(null,"getContextInfo",A,null)
};
gadgets.sciverse.getEuidCookie=function(A){gadgets.rpc.call(null,"getEuidCookie",A,null)
};
gadgets.sciverse.getPageUrl=function(A){gadgets.rpc.call("","getPageUrl",A,null)
};
gadgets.sciverse.getResults=function(A,B){gadgets.rpc.call(null,"getResults",B,A)
};
gadgets.sciverse.getSubjectAreas=function(B,A){if(typeof (A)=="undefined"||A==null){return 
}gadgets.rpc.call(null,"getSubjectAreas",null,B);
gadgets.rpc.register(B,A)
};
gadgets.sciverse.getSubType=function(B,A){if(typeof (A)=="undefined"||A==null){return 
}gadgets.rpc.call(null,"getSubType",null,B);
gadgets.rpc.register(B,A)
};
gadgets.sciverse.addButtonsToAllResults=function(D,A,C,B){if(typeof (D)=="undefined"||D==null){return 
}if(typeof (B)=="undefined"||B==null){return 
}gadgets.rpc.call("","addButtons",D,null,A,C);
gadgets.rpc.register(C,B)
};
gadgets.sciverse.addButtonsToResults=function(E,A,B,D,C){if(typeof (E)=="undefined"||E==null){return 
}if(typeof (C)=="undefined"||C==null){return 
}gadgets.rpc.call("","addButtons",E,A,B,D);
gadgets.rpc.register(D,C)
};
gadgets.sciverse.closeAllMyHovers=function(){gadgets.rpc.call("","closeAllMyHovers",null,null)
};
gadgets.sciverse.closeCanvasView=function(){gadgets.rpc.call("","closeCanvasView",null,null)
};
gadgets.sciverse.closeHover=function(A){if(typeof (A)=="undefined"||A==null){return 
}gadgets.rpc.call(null,"closeHover",null,A)
};
gadgets.sciverse.entitleGadget=function(A){gadgets.rpc.call("","entitleGadget",null,A)
};
gadgets.sciverse.executeSearch=function(A){gadgets.rpc.call(null,"executeSearch",null,A)
};
gadgets.sciverse.invokeColumnView=function(B,A){gadgets.rpc.call(null,"invokeColumnView",null,B,A)
};
gadgets.sciverse.invokeResultsView=function(A,B){gadgets.rpc.call(null,"invokeResultsView",null,A,B)
};
gadgets.sciverse.invokeWorkSpaceView=function(A){gadgets.rpc.call(null,"invokeWorkSpaceView",null,A)
};
gadgets.sciverse.makeContentApiRequest=function(B,F,D){var C="1";
var A="?";
if(B.indexOf("?")>-1){A="&"
}B=[B,A,"nocache=",C].join("");
var E={};
E[gadgets.io.RequestParameters.HEADERS]=D;
E[gadgets.io.RequestParameters.AUTHORIZATION]=gadgets.io.AuthorizationType.NONE;
if(D.Accept=="application/json"){E[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.JSON
}else{if(D.Accept=="application/atom+xml"){E[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.FEED
}}gadgets.io.makeRequest(B,F,E)
};
gadgets.sciverse.makeMeInvisible=function(){gadgets.rpc.call("","makeMeInvisible",null,null)
};
gadgets.sciverse.makeMeVisible=function(){gadgets.rpc.call("","makeMeVisible",null,null)
};
gadgets.sciverse.makeRequest=function(B,F,E,C){if(typeof (C)=="undefined"||C==null){C=true
}if(C){var D="1";
var A="?";
if(B.indexOf("?")>-1){A="&"
}B=[B,A,"nocache=",D].join("")
}gadgets.io.makeRequest(B,F,E)
};
gadgets.sciverse.linkText=function(D,B,F,A,E,C){if(typeof (C)=="undefined"||C==null){return 
}gadgets.rpc.call("","linkText",null,D,B,F,A,E);
gadgets.rpc.register(E,C)
};
gadgets.sciverse.removeButtonsFromAllResults=function(){gadgets.rpc.call("","removeButtons",null,null)
};
gadgets.sciverse.removeButtonsFromResults=function(A,B){gadgets.rpc.call("","removeButtons",null,A,B)
};
gadgets.sciverse.returnQuerySuggestions=function(B,A){if(typeof (B)=="undefined"||B==null||typeof (A)=="undefined"||A==null){return 
}gadgets.rpc.call(null,"suggest",null,B,A)
};
gadgets.sciverse.showHoverView=function(B,A,C){if(typeof (C)=="undefined"||C==null){return 
}gadgets.rpc.call(null,"showHoverView",C,B,A)
};
gadgets.sciverse.subscribeHighlightedText=function(B,A){if(typeof (A)=="undefined"||A==null){return 
}gadgets.rpc.call(null,"subscribe",null,"highlightedText",B);
gadgets.rpc.register(B,A)
};
gadgets.sciverse.subscribeToInterRef=function(B,A){if(typeof (A)=="undefined"||A==null){return 
}gadgets.rpc.call(null,"subscribe",null,"interRef",B);
gadgets.rpc.register(B,A)
};
gadgets.sciverse.subscribeToNavigatorSelection=function(B,A){if(typeof (A)=="undefined"||A==null){alert("Please provide a callback handler");
return 
}gadgets.rpc.call(null,"subscribe",null,"selection",B);
gadgets.rpc.register(B,A)
};
gadgets.sciverse.subscribeToResults=function(B,A){if(typeof (A)=="undefined"||A==null){return 
}gadgets.rpc.call(null,"subscribe",null,"results",B);
gadgets.rpc.register(B,A)
};
gadgets.sciverse.subscribeToQuery=function(B,A){if(typeof (A)=="undefined"||A==null){return 
}gadgets.rpc.call(null,"subscribe",null,"query",B);
gadgets.rpc.register(B,A)
}
}());;
gadgets.window=gadgets.window||{};
(function(){gadgets.window.getViewportDimensions=function(){var A=0;
var B=0;
if(self.innerHeight){A=self.innerWidth;
B=self.innerHeight
}else{if(document.documentElement&&document.documentElement.clientHeight){A=document.documentElement.clientWidth;
B=document.documentElement.clientHeight
}else{if(document.body){A=document.body.clientWidth;
B=document.body.clientHeight
}}}return{width:A,height:B}
}
})();;
gadgets.window=gadgets.window||{};
(function(){var C;
function A(F,D){var E=window.getComputedStyle(F,"");
var G=E.getPropertyValue(D);
G.match(/^([0-9]+)/);
return parseInt(RegExp.$1,10)
}function B(){var E=0;
var D=[document.body];
while(D.length>0){var I=D.shift();
var H=I.childNodes;
for(var G=0;
G<H.length;
G++){var J=H[G];
if(typeof J.offsetTop!=="undefined"&&typeof J.scrollHeight!=="undefined"){var F=J.offsetTop+J.scrollHeight+A(J,"margin-bottom");
E=Math.max(E,F)
}D.push(J)
}}return E+A(document.body,"border-bottom")+A(document.body,"margin-bottom")+A(document.body,"padding-bottom")
}gadgets.window.adjustHeight=function(I){var F=parseInt(I,10);
var E=false;
if(isNaN(F)){E=true;
var K=gadgets.window.getViewportDimensions().height;
var D=document.body;
var J=document.documentElement;
if(document.compatMode==="CSS1Compat"&&J.scrollHeight){F=J.scrollHeight!==K?J.scrollHeight:J.offsetHeight
}else{if(navigator.userAgent.indexOf("AppleWebKit")>=0){F=B()
}else{if(D&&J){var G=J.scrollHeight;
var H=J.offsetHeight;
if(J.clientHeight!==H){G=D.scrollHeight;
H=D.offsetHeight
}if(G>K){F=G>H?G:H
}else{F=G<H?G:H
}}}}}if(F!==C&&!isNaN(F)&&!(E&&F===0)){C=F;
gadgets.rpc.call(null,"resize_iframe",null,F)
}}
}());
var _IG_AdjustIFrameHeight=gadgets.window.adjustHeight;;
var tamings___=tamings___||[];
tamings___.push(function(A){caja___.whitelistFuncs([[gadgets.window,"adjustHeight"],[gadgets.window,"getViewportDimensions"]])
});;
gadgets.views=function(){var E=null;
var B={};
var D={};
function A(H){if(!H){H=window.event
}var G;
if(H.target){G=H.target
}else{if(H.srcElement){G=H.srcElement
}}if(G.nodeType===3){G=G.parentNode
}if(G.nodeName.toLowerCase()==="a"){var F=G.getAttribute("href");
if(F&&F[0]!=="#"&&F.indexOf("://")===-1){gadgets.views.requestNavigateTo(E,F);
if(H.stopPropagation){H.stopPropagation()
}if(H.preventDefault){H.preventDefault()
}H.returnValue=false;
H.cancelBubble=true;
return false
}}return false
}function C(I){var H=I.views||{};
for(var L in H){if(H.hasOwnProperty(L)){if(L!="rewriteLinks"){var M=H[L];
if(!M){continue
}B[L]=new gadgets.views.View(L,M.isOnlyVisible);
var F=M.aliases||[];
for(var K=0,J;
(J=F[K]);
++K){B[J]=new gadgets.views.View(L,M.isOnlyVisible)
}}}}var G=gadgets.util.getUrlParameters();
if(G["view-params"]){D=gadgets.json.parse(G["view-params"])||D
}E=B[G.view]||B["default"];
if(H.rewriteLinks){gadgets.util.attachBrowserEvent(document,"click",A,false)
}}gadgets.config.register("views",null,C);
return{bind:function(W,U){if(typeof W!=="string"){throw new Error("Invalid urlTemplate")
}if(typeof U!=="object"){throw new Error("Invalid environment")
}var R=/^([a-zA-Z0-9][a-zA-Z0-9_\.\-]*)(=([a-zA-Z0-9\-\._~]|(%[0-9a-fA-F]{2}))*)?$/,Y=new RegExp("\\{([^}]*)\\}","g"),V=/^-([a-zA-Z]+)\|([^|]*)\|(.+)$/,M=[],Q=0,K,J,H,P,L,G,N,S;
function I(a,Z){return U.hasOwnProperty(a)?U[a]:Z
}function F(Z){if(!(J=Z.match(R))){throw new Error("Invalid variable : "+Z)
}}function X(d,Z,c){var a,b=d.split(",");
for(a=0;
a<b.length;
++a){F(b[a]);
if(c(Z,I(J[1]),J[1])){break
}}return Z
}function T(Z){if((typeof Z==="object")||(typeof Z==="function")){for(var a in Z){if(Z.hasOwnProperty(a)){return false
}}return true
}return false
}while((K=Y.exec(W))){M.push(W.substring(Q,K.index));
Q=Y.lastIndex;
if((J=K[1].match(R))){H=J[1];
P=J[2]?J[2].substr(1):"";
M.push(I(H,P))
}else{if((J=K[1].match(V))){L=J[1];
G=J[2];
N=J[3];
S=0;
switch(L){case"neg":S=1;
case"opt":if(X(N,{flag:S},function(a,Z){if(typeof Z!=="undefined"&&!T(Z)){a.flag=!a.flag;
return 1
}return 0
}).flag){M.push(G)
}break;
case"join":M.push(X(N,[],function(b,a,Z){if(typeof a==="string"){b.push(Z+"="+a)
}else{if(typeof a==="object"){for(var c in a){if(a.hasOwnProperty(c)){b.push(c+"="+a[c])
}}}}}).join(G));
break;
case"list":F(N);
var O=I(J[1]);
if(typeof O==="object"&&typeof O.join==="function"){M.push(O.join(G))
}break;
case"prefix":S=1;
case"suffix":F(N);
O=I(J[1],J[2]&&J[2].substr(1));
if(typeof O==="string"){M.push(S?G+O:O+G)
}else{if(typeof O==="object"&&typeof O.join==="function"){M.push(S?G+O.join(G):O.join(G)+G)
}}break;
default:throw new Error("Invalid operator : "+L)
}}else{throw new Error("Invalid syntax : "+K[0])
}}}M.push(W.substr(Q));
return M.join("")
},requestNavigateTo:function(F,H,G){if(typeof F!=="string"){F=F.getName()
}gadgets.rpc.call(null,"requestNavigateTo",null,F,H,G)
},getCurrentView:function(){return E
},getSupportedViews:function(){return B
},getParams:function(){return D
}}
}();
gadgets.views.View=function(A,B){this.name_=A;
this.isOnlyVisible_=!!B
};
gadgets.views.View.prototype.getName=function(){return this.name_
};
gadgets.views.View.prototype.getUrlTemplate=function(){return gadgets.config&&gadgets.config.views&&gadgets.config.views[this.name_]&&gadgets.config.views[this.name_].urlTemplate
};
gadgets.views.View.prototype.bind=function(A){return gadgets.views.bind(this.getUrlTemplate(),A)
};
gadgets.views.View.prototype.isOnlyVisibleGadget=function(){return this.isOnlyVisible_
};
gadgets.views.ViewType=gadgets.util.makeEnum(["CANVAS","HOME","PREVIEW","PROFILE","FULL_PAGE","DASHBOARD","POPUP"]);;
var tamings___=tamings___||[];
tamings___.push(function(A){caja___.whitelistCtors([[gadgets.views,"View",Object]]);
caja___.whitelistMeths([[gadgets.views.View,"bind"],[gadgets.views.View,"getUrlTemplate"],[gadgets.views.View,"isOnlyVisibleGadget"],[gadgets.views.View,"getName"]]);
caja___.whitelistFuncs([[gadgets.views,"getCurrentView"],[gadgets.views,"getParams"],[gadgets.views,"requestNavigateTo"]])
});;
gadgets.hub={};
(function(){gadgets.hub.executeSearch=function(A){gadgets.rpc.call(null,"executeHubSearch",null,A)
};
gadgets.hub.subscribeToSummaryView=function(B,A){if(typeof (A)=="undefined"||A==null){return 
}gadgets.rpc.call(null,"subscribe",null,"hubSummaryView",B);
gadgets.rpc.register(B,A)
}
}());;
gadgets.config.init({"shindig.auth":{},"rpc":{"passReferrer":"c2p:query","parentRelayUrl":"/container/rpc_relay.html","useLegacyProtocol":false,"commSwf":"http://idc311-sciverse-shindig.elsevier.com/xpc.swf"},"views":{"profile":{"aliases":["DASHBOARD","default"],"isOnlyVisible":false,"urlTemplate":"http://localhost/gadgets/profile?{var}"},"canvas":{"aliases":["FULL_PAGE"],"isOnlyVisible":true,"urlTemplate":"http://localhost/gadgets/canvas?{var}"}},"core.util":{"sciverse":{},"content-rewrite":{"include-tags":"","include-urls":"","exclude-urls":".*"},"dynamic-height":{},"views":{},"core":{},"hub":{}},"core.io":{"proxyUrl":"//%host%/gadgets/proxy?container=default&refresh=%refresh%&url=%url%%rewriteMime%","jsonProxyUrl":"//%host%/gadgets/makeRequest"}});
</script><script>gadgets.Prefs.setMessages_({});gadgets.Prefs.setDefaultPrefs_({});gadgets.io.preloaded_=[];</script>
	
	
	
	
		

	
<link rel="stylesheet" type="text/css" href="S0042682285710161_9.css" media="all">
</head>
<body dir="ltr"><script src="analytics.js" type="text/javascript"></script><script type="text/javascript">

	var twPrefix = "Found on #Sciverse:";
	var encTwPrefix = encodeURIComponent(twPrefix);
	var twShortenedUrlLength = 20;
	var nonUrlLength = twPrefix.length+twShortenedUrlLength+1;

	function getScopusRecordPageUrl(docLink) {
		//Build a short URL for the Scopus record page
		var newDocLink = docLink; 
		var url = "http://www.scopus.com/record/display.url";
		var queryString = docLink.split("?")[1];
		if (queryString) {
			var attrs = queryString.split("&");
			var eid;
			var origin;
			for (var i=0;i<attrs.length;i++) {
				var eachAttr = attrs[i];
				var keyValArray = eachAttr.split("=");
				if ("eid" == keyValArray[0]) {
				    eid = keyValArray[1];
				}
				if ("origin" == keyValArray[0]) {
					origin = keyValArray[1]
				}
			}
			newDocLink = url + "?eid=" + eid + "&origin=" + origin;
		} else {
			//no query string so just use the page url
			newDocLink = newDocLink.replace('(','%28');
			newDocLink = newDocLink.replace(')','%29');
		}
		return newDocLink;
	}

	function render(data, pageType, platform) {

			//encode data
		var encDocTitle = encodeURIComponent(data.title);
		var encDocLink; 
		var docLink; 

		//get DOI or URL
		var doiExists = true;
		if (data.doi == "" || data.doi == "null" || data.doi == null) {
			encDocLink = encodeURIComponent(data.URL);
			docLink = data.URL;
			doiExists = false;
			
		} else {
			docLink = "http://dx.doi.org/" + data.doi;
			encDocLink = encodeURIComponent(docLink);
		}
		

		//create Citeulike link
		var cuLink = "";
		
		if (doiExists) {
			cuLink = "<a class='citeulike' href='#' onclick=";
			cuLink += "gadgetAnalytics.trackCiteulike('" + docLink + "');window.open('http://www.citeulike.org/posturl?url=" ;
			cuLink += encDocLink;
			cuLink += "&title=";
			cuLink += encDocTitle;
			cuLink += "','citeulike','width=855,height=550,resizable=yes,scrollbars=yes');>";
			cuLink += "<img src='http://static.citeulike.org/img/small-logo.png' border='0' alt='Citeulike'>";
			cuLink += "</a>";
		}
		
		if ( pageType && (pageType === 'recordpage' || pageType === 'article') ) {
			// in this case we want to share the page url on FB and twitter, not the doi url
			docLink = data.URL;
			
			if (pageType === 'recordpage') {			
				docLink = getScopusRecordPageUrl(docLink);
			}
					
			encDocLink = encodeURIComponent(docLink);
		}

		//create Facebook link
		var fbLink = '<a class="fb fb_btn" href="javascript:void(0)" onclick="';
		fbLink += "gadgetAnalytics.trackFacebookLike('" + docLink + "');window.open('https://www.facebook.com/sharer/sharer.php?u=" + encodeURIComponent(encDocLink);
		fbLink += "&t=" + escape(encDocTitle) + "', 'facebook', 'width=750,height=550');";
		fbLink += 'return false;"><span class="liketext">Like</span></a>';
		
		//create twitter link
		var encTwDocTitle = encDocTitle;
		if (data.title.length > (140-nonUrlLength)) {	
			encTwDocTitle = encodeURIComponent(data.title.substring(0, data.title.length-(data.title.length+nonUrlLength-140)));
		}

		var twLink = '<a class="tb" href="javascript:void(0)" onclick="';
		twLink += "gadgetAnalytics.trackTwitterTweet('" + docLink + "');window.open('http://twitter.com/home?status=" + encTwPrefix + encTwDocTitle;
		twLink += "%20" + encDocLink + "', 'twitter', 'width=750,height=550'); ";
		twLink += 'return false;">';
	 	twLink += '<i></i>Tweet</a>';

		//write all share links
		var shareContent = document.getElementById("share");
		var html = cuLink;
		html += "&nbsp;&nbsp;&nbsp;";
		if (platform != "SC") {
			html += fbLink;
			html += "&nbsp;&nbsp;&nbsp;";
		}
		html += twLink;
		
		shareContent.innerHTML = html;
				
		gadgets.window.adjustHeight();		
	}

	</script><div id="share" style="padding-left: 10px; margin-top: 5px;"><a class="citeulike" href="http://dx.doi.org/10.1006/viro.1995.1016"><img src="small-logo.png" alt="Citeulike" border="0"></a>&nbsp;&nbsp;&nbsp;<a class="fb fb_btn" href="http://www.sciencedirect.com/science/article/pii/S0042682285710161"><span class="liketext">Like</span></a>&nbsp;&nbsp;&nbsp;<a class="tb" href="http://www.sciencedirect.com/science/article/pii/S0042682285710161"><i></i>Tweet</a></div>
	<script type="text/javascript">


	var resultsWithoutCiteULike;
	var resultsWithCiteULike;
	
	var context;
	var pageOffset;
	
	var buttonsWithCiteULike = new Array();
	buttonsWithCiteULike.push({'imageUrl':'http://static.citeulike.org/img/small-logo.png',    'altText':'CiteULike'});
	buttonsWithCiteULike.push({'imageUrl':'http://dl.dropbox.com/u/18693127/like.png', 'altText':'Like'});
	buttonsWithCiteULike.push({'imageUrl':'http://dl.dropbox.com/u/18693127/tweet.png', 'altText':'Tweet'});

	var buttonsWithoutCiteULike = new Array();
	buttonsWithoutCiteULike.push({'imageUrl':'http://dl.dropbox.com/u/18693127/like.png', 'altText':'Like'});
	buttonsWithoutCiteULike.push({'imageUrl':'http://dl.dropbox.com/u/18693127/tweet.png', 'altText':'Tweet'});
	
	function init() {
		gadgets.sciverse.getContextInfo(contextCallback);
	}			

	function returnValueHandler1(obj){
		resultsWithoutCiteULike = obj;
	}		
		
	function returnValueHandler2(obj){
		resultsWithCiteULike = obj;
	}		

	function buttonsHandler(resultNum, buttonId, x, y){
		
		var platform = context.platform;
		
		gadgets.sciverse.getResults([(parseInt(resultNum)-pageOffset)+''], function (resultsDocs) {
	         if (resultsDocs == null) {
                gadgetAnalytics.log("No results on the page.  Should not be a normal case.");
                return;
            }
			var doc = resultsDocs[0];
			
			var docTitle; 
			if ( platform === 'SVH' ) {
				docTitle = doc.itemTitle;
			} else if ( platform === 'SD' ) {
				docTitle = doc.docTitle_N;
			} else if ( platform === 'SC' ) {
				docTitle = doc.itemtitle;
			} else { }
			
			//strip out idiotic <key> tags
			var myRegExp = new RegExp("/","g");
			docTitle = docTitle.replace(/<[\/]?key>/gi, "");
			
			docTitle = docTitle.replace(/<\/span>/gi,"");
			docTitle = docTitle.replace(/ <span class="hl1">/gi,"");

			var docDOI = doc.doi;
			var docLink = doc.txt10;

			//encode data
			var encDocTitle = encodeURIComponent(docTitle);
			var encDocLink; 

			//get DOI or URL
			var doiExists = true;
			if (docDOI == "" || docDOI == "null" || docDOI == null) {
				encDocLink = encodeURIComponent(docLink);
				
			} else {
				docLink = "http://dx.doi.org/" + docDOI;
				encDocLink = encodeURIComponent(docLink);
			}

			//Determine the type of button clicked.
			if ( resultsWithoutCiteULike[resultNum] != undefined ) {
				var buttonIds = resultsWithoutCiteULike[resultNum];
				var index = buttonIds.indexOf(buttonId);
				switch (index) {
					case 0:
						//Facebook Like button
						openFacebookWindow(docLink, encDocLink, encDocTitle);
						break;
					case 1: 
						//Tweet button
						openTwitterWindow(docLink, encDocLink, docTitle, encDocTitle);
						break;
				}
			}
			
			if ( resultsWithCiteULike[resultNum] != undefined ) {
				var buttonIds = resultsWithCiteULike[resultNum];
				var index = buttonIds.indexOf(buttonId);
				switch (index) {
					case 0:
						//Cite U Like button
						openCiteULikeWindow(docLink, encDocLink, encDocTitle);
						break;
					case 1:
						//Facebook Like button
						openFacebookWindow(docLink, encDocLink, encDocTitle);
						break;
					case 2: 
						//Tweet button
						openTwitterWindow(docLink, encDocLink, docTitle, encDocTitle);
						break;
				}
			}
			
			
		});
	}
	
	function openFacebookWindow(docLink, encDocLink, encDocTitle) {
		gadgetAnalytics.trackFacebookLike(docLink);
		window.open('https://www.facebook.com/sharer/sharer.php?u=' 
			+ encodeURIComponent(encDocLink) 
			+ "&t=" + escape(encDocTitle), 'facebook', 'width=750,height=550');

	}
	
	function openTwitterWindow(docLink, encDocLink, docTitle, encDocTitle) {
		//create twitter link
		var encTwDocTitle = encDocTitle;	
		if (docTitle.length > (140-nonUrlLength)) {	
			encTwDocTitle = encodeURIComponent(docTitle.substring(0, docTitle.length-(docTitle.length+nonUrlLength-140)));
		}

		gadgetAnalytics.trackTwitterTweet(docLink );
		window.open('http://twitter.com/home?status=' + encTwPrefix + encTwDocTitle
					 + "%20" + encDocLink, 'twitter', 'width=750,height=550');
	}
	
	function openCiteULikeWindow(docLink, encDocLink, encDocTitle) {
		gadgetAnalytics.trackCiteulike(docLink);
		window.open('http://www.citeulike.org/posturl?url=' + encDocLink 
			+ '&title=' + encDocTitle, 'citeulike','width=855,height=550,resizable=yes,scrollbars=yes');
	}
	function contextCallback(ctxInfo) {
		context = ctxInfo;
		
		var platform = ctxInfo.platform;
		var pageType = ctxInfo.pageType;
		if ( pageType.toUpperCase() === 'RESULTSLIST' ) {
			//get results
			gadgets.sciverse.getAllResults(function (resultsDocs) {
	
				var resultsArrayWithCiteULike = new Array();
				var resultsArrayWithoutCiteULike = new Array();
				
				var offset = resultsDocs[0].offset;
				pageOffset = offset;
				
				//cycle through docs, get title and link
				for(var doc in resultsDocs){
	
					var docDOI = resultsDocs[doc].doi;

					if (docDOI == "" || docDOI == "null" || docDOI == null) {
						// No DOI so no CiteULike link
						resultsArrayWithoutCiteULike.push(resultsDocs[doc].offset);
					} else {
						resultsArrayWithCiteULike.push(resultsDocs[doc].offset);
					}
					//***** build list of buttons to add to each result *****/
				}	

				gadgets.sciverse.addButtonsToResults(returnValueHandler1,resultsArrayWithoutCiteULike,buttonsWithoutCiteULike, 'myButtonsHandler',buttonsHandler);	
				
				gadgets.sciverse.addButtonsToResults(returnValueHandler2,resultsArrayWithCiteULike,buttonsWithCiteULike, 'myButtonsHandler',buttonsHandler);		
				
				// Render the toolbar gadget on the Hub results page.
				gadgets.sciverse.getPageUrl(function (pageUrl) {
					//make json object
					var docData = { "title":"SciVerse Hub Search Results", 
									"doi":"",
									"URL":pageUrl};
					
					render(docData);
				});
			});
		} else if ( pageType === 'article') { // on SD article page

			gadgets.sciverse.makeMeVisible();

			//Get teh doc title
			var docTitle = ctxInfo.docTitle_N;
			var docDOI = ctxInfo.doi;
			var docLink;
			gadgets.sciverse.getPageUrl(function (pageUrl) {
				docLink = pageUrl;
				//make json object
				var docData = { "title":docTitle, 
								"doi":docDOI,
								"URL":docLink };
				
				render(docData, pageType, platform);
			});
			
		} else if ( pageType === 'recordpage' )  {  // on SC record page
			gadgets.sciverse.makeMeVisible();

			//Get teh doc title
			var docTitle = ctxInfo.docTitle;
			var docDOI = ctxInfo.doi;
			var docLink;
			gadgets.sciverse.getPageUrl(function (pageUrl) {
				docLink = pageUrl;
				//make json object
				var docData = { "title":docTitle, 
								"doi":docDOI,
								"URL":docLink };
				render(docData, pageType, platform);
			});
		}
		gadgetAnalytics.initialize('UA-32952706-1');
		gadgetAnalytics.trackPageview('Share',ctxInfo);
	}

	gadgets.util.registerOnLoadHandler(function(){
		init();	
		gadgets.sciverse.subscribeToResults('resultsCallback', init);
		gadgets.hub.subscribeToSummaryView('summaryViewCallback', init);
	});
	</script>
	
	<script>gadgets.util.runOnLoadHandlers();</script></body>
</html>
